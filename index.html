<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionnaire de Tournoi Ultimate</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .section h2 {
            color: #764ba2;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .team-setup {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        input, select, button {
            padding: 12px 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        button:hover {
            background: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        .teams-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .team-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .team-card span {
            font-weight: bold;
            color: #333;
        }

        .delete-btn {
            background: #e74c3c;
            padding: 5px 10px;
            font-size: 14px;
        }

        .delete-btn:hover {
            background: #c0392b;
        }

        .matches-grid {
            display: grid;
            gap: 20px;
            margin-top: 20px;
        }

        .match-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .match-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        .match-title {
            font-weight: bold;
            color: #764ba2;
            font-size: 1.1em;
        }

        .teams-scores {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            align-items: center;
            margin: 20px 0;
        }

        .team-score {
            text-align: center;
        }

        .team-name {
            font-weight: bold;
            font-size: 1.2em;
            color: #333;
            margin-bottom: 10px;
        }

        .score-display {
            font-size: 3em;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }

        .score-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
        }

        .score-input {
            width: 80px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            padding: 8px;
        }

        .score-btn {
            width: 50px;
            height: 50px;
            font-size: 20px;
            padding: 0;
            border-radius: 50%;
        }

        .vs {
            font-size: 2em;
            font-weight: bold;
            color: #999;
        }

        .badge-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #eee;
        }

        .badge-status {
            display: inline-block;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }

        .badge-validated {
            background: #d4edda;
            color: #155724;
        }

        .badge-pending {
            background: #fff3cd;
            color: #856404;
        }

        .classement-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .classement-table th,
        .classement-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .classement-table th {
            background: #667eea;
            color: white;
            font-weight: bold;
        }

        .classement-table tr:hover {
            background: #f8f9fa;
        }

        .classement-table td:first-child {
            font-weight: bold;
            color: #764ba2;
        }

        .timer-section {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .timer-display {
            font-size: 3em;
            font-weight: bold;
            color: #667eea;
            margin: 15px 0;
        }

        .timer-display.warning {
            color: #e67e22;
        }

        .timer-display.danger {
            color: #e74c3c;
        }

        .timer-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .nav-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .hidden {
            display: none;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü•è Gestionnaire de Tournoi Ultimate</h1>

        <div class="section" id="setupSection">
            <h2>Configuration des √âquipes</h2>
            <div class="team-setup">
                <input type="text" id="teamNameInput" placeholder="Nom de l'√©quipe" />
                <button onclick="addTeam()">Ajouter √âquipe</button>
            </div>
            <div class="teams-list" id="teamsList"></div>
            
            <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #ddd;">
                <h3 style="color: #764ba2; margin-bottom: 15px;">Configuration du tournoi</h3>
                <div class="team-setup">
                    <select id="fieldsSelect" style="min-width: 200px;">
                        <option value="1">1 terrain</option>
                        <option value="2">2 terrains</option>
                        <option value="3">3 terrains</option>
                        <option value="4" selected>4 terrains</option>
                        <option value="5">5 terrains</option>
                        <option value="6">6 terrains</option>
                        <option value="7">7 terrains</option>
                        <option value="8">8 terrains</option>
                    </select>
                    <input type="number" id="matchDuration" placeholder="Dur√©e match (min)" 
                           value="10" min="1" max="60" style="width: 180px;">
                </div>
                
                <div style="margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                    <h4 style="color: #333; margin-bottom: 15px;">Options avanc√©es</h4>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="enableTurnovers" checked style="width: 20px; height: 20px;">
                            <span style="font-weight: bold;">Activer les pertes de disque</span>
                        </label>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="enableBadges" checked onchange="toggleBadgeConfig()" 
                                   style="width: 20px; height: 20px;">
                            <span style="font-weight: bold;">Activer la validation des badges</span>
                        </label>
                    </div>
                    
                    <div id="badgeConfig" style="margin-left: 30px; margin-top: 10px;">
                        <div style="margin-bottom: 10px;">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="radio" name="badgeType" value="points" checked onchange="toggleBadgeCriteria()" 
                                       style="width: 18px; height: 18px;">
                                <span>Valider par nombre de points :</span>
                                <input type="number" id="badgePoints" value="4" min="1" max="20" 
                                       style="width: 80px; padding: 5px;">
                            </label>
                        </div>
                        <div>
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="radio" name="badgeType" value="efficiency" onchange="toggleBadgeCriteria()" 
                                       style="width: 18px; height: 18px;">
                                <span>Valider par % d'efficacit√© :</span>
                                <input type="number" id="badgeEfficiency" value="70" min="1" max="100" 
                                       style="width: 80px; padding: 5px;" disabled>
                                <span>%</span>
                            </label>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="enableHuddle" style="width: 20px; height: 20px;">
                            <span style="font-weight: bold;">Activer les notes Huddle (Fair-Play sur 9)</span>
                        </label>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <button onclick="startTournament()" style="background: #27ae60; font-size: 18px; padding: 15px 30px;">
                        D√©marrer le Tournoi
                    </button>
                </div>
            </div>
        </div>

        <div class="section hidden" id="matchesSection">
            <h2>Matchs en Cours</h2>
            <div class="alert alert-info" id="currentRoundInfo"></div>
            
            <div class="timer-section">
                <div id="timerStatus" style="font-size: 1.2em; color: #666; margin-bottom: 10px;">
                    Chronom√®tre pr√™t
                </div>
                <div class="timer-display" id="timerDisplay">--:--</div>
                <div class="timer-controls">
                    <button onclick="startTimer()" id="startTimerBtn" style="background: #27ae60;">
                        ‚ñ∂ D√©but du match
                    </button>
                    <button onclick="pauseTimer()" id="pauseTimerBtn" style="background: #e67e22; display: none;">
                        ‚è∏ Pause
                    </button>
                    <button onclick="resetTimer()" style="background: #95a5a6;">
                        ‚ü≤ R√©initialiser
                    </button>
                </div>
            </div>
            
            <div class="matches-grid" id="matchesGrid"></div>
            
            <div class="nav-buttons">
                <button onclick="previousRound()" id="prevRoundBtn" style="background: #95a5a6;">
                    ‚Üê Manche pr√©c√©dente
                </button>
                <button onclick="nextRound()" id="nextRoundBtn" style="background: #e67e22; font-size: 18px; padding: 15px 30px;">
                    Manche suivante ‚Üí
                </button>
                <button onclick="endTournament()" id="endTournamentBtn" style="background: #e74c3c; display: none;">
                    üèÅ Terminer le tournoi
                </button>
            </div>
        </div>

        <div class="section hidden" id="rankingSection">
            <h2>Classement</h2>
            <table class="classement-table">
                <thead>
                    <tr id="rankingHeader"></tr>
                </thead>
                <tbody id="rankingBody"></tbody>
            </table>
            <div style="margin-top: 20px; text-align: center;">
                <button onclick="exportClassement()" style="background: #3498db; font-size: 16px; padding: 12px 25px;">
                    üìä Exporter le classement (Excel)
                </button>
            </div>
        </div>
    </div>

    <script>
        let teams = [];
        let matches = [];
        let numFields = 4;
        let currentRound = 0;
        let matchRounds = [];
        let matchDuration = 10;
        let timerInterval = null;
        let remainingTime = 0;
        let timerRunning = false;
        let enableTurnovers = true;
        let enableBadges = true;
        let badgeType = 'points';
        let badgePoints = 4;
        let badgeEfficiency = 70;
        let enableHuddle = false;

        function toggleBadgeConfig() {
            const enabled = document.getElementById('enableBadges').checked;
            document.getElementById('badgeConfig').style.display = enabled ? 'block' : 'none';
        }

        function toggleBadgeCriteria() {
            const type = document.querySelector('input[name="badgeType"]:checked').value;
            document.getElementById('badgePoints').disabled = (type !== 'points');
            document.getElementById('badgeEfficiency').disabled = (type !== 'efficiency');
        }

        function addTeam() {
            const input = document.getElementById('teamNameInput');
            const teamName = input.value.trim();

            if (teamName === '') {
                alert('Veuillez entrer un nom d\'√©quipe');
                return;
            }

            if (teams.length >= 10) {
                alert('Maximum 10 √©quipes');
                return;
            }

            if (teams.some(t => t.name === teamName)) {
                alert('Cette √©quipe existe d√©j√†');
                return;
            }

            teams.push({
                id: Date.now(),
                name: teamName,
                wins: 0,
                losses: 0,
                pointsFor: 0,
                pointsAgainst: 0,
                turnovers: 0,
                badges: 0,
                huddleTotal: 0,
                huddleCount: 0
            });

            input.value = '';
            displayTeams();
        }

        function deleteTeam(teamId) {
            teams = teams.filter(t => t.id !== teamId);
            displayTeams();
        }

        function displayTeams() {
            const list = document.getElementById('teamsList');
            list.innerHTML = teams.map(team => 
                '<div class="team-card"><span>' + team.name + '</span><button class="delete-btn" onclick="deleteTeam(' + team.id + ')">‚úï</button></div>'
            ).join('');
        }

        function startTournament() {
            if (teams.length < 2) {
                alert('Minimum 2 √©quipes requises');
                return;
            }

            numFields = parseInt(document.getElementById('fieldsSelect').value);
            matchDuration = parseInt(document.getElementById('matchDuration').value) || 10;
            enableTurnovers = document.getElementById('enableTurnovers').checked;
            enableBadges = document.getElementById('enableBadges').checked;
            enableHuddle = document.getElementById('enableHuddle').checked;
            
            if (enableBadges) {
                badgeType = document.querySelector('input[name="badgeType"]:checked').value;
                badgePoints = parseInt(document.getElementById('badgePoints').value) || 4;
                badgeEfficiency = parseInt(document.getElementById('badgeEfficiency').value) || 70;
            }
            
            generateMatches();
            organizeRounds();
            
            const validation = validateTournament();
            if (!validation.valid) {
                alert('Erreur : ' + validation.message);
                return;
            }
            
            currentRound = 0;
            
            let headerHTML = '<th>√âquipe</th><th>Victoires</th>';
            if (enableTurnovers) headerHTML += '<th>% Efficacit√©</th>';
            if (enableBadges) headerHTML += '<th>Badges valid√©s</th>';
            if (enableHuddle) headerHTML += '<th>Moy. Huddle</th>';
            document.getElementById('rankingHeader').innerHTML = headerHTML;
            
            document.getElementById('setupSection').classList.add('hidden');
            document.getElementById('matchesSection').classList.remove('hidden');
            document.getElementById('rankingSection').classList.remove('hidden');
            displayCurrentRound();
            updateRanking();
            resetTimer();
        }

        function generateMatches() {
            matches = [];
            let matchId = 1;
            
            for (let i = 0; i < teams.length; i++) {
                for (let j = i + 1; j < teams.length; j++) {
                    matches.push({
                        id: matchId++,
                        team1: teams[i],
                        team2: teams[j],
                        score1: 0,
                        score2: 0,
                        turnovers1: 0,
                        turnovers2: 0,
                        huddle1: 0,
                        huddle2: 0,
                        field: null
                    });
                }
            }
        }

        function organizeRounds() {
            matchRounds = [];
            let remaining = [...matches];
            
            while (remaining.length > 0) {
                let round = [];
                let usedTeams = new Set();
                let available = [...remaining];
                
                while (round.length < numFields && available.length > 0) {
                    let added = false;
                    
                    for (let i = 0; i < available.length; i++) {
                        const match = available[i];
                        
                        if (!usedTeams.has(match.team1.id) && !usedTeams.has(match.team2.id)) {
                            match.field = round.length + 1;
                            round.push(match);
                            usedTeams.add(match.team1.id);
                            usedTeams.add(match.team2.id);
                            available.splice(i, 1);
                            added = true;
                            break;
                        }
                    }
                    
                    if (!added) break;
                }
                
                if (round.length > 0) {
                    matchRounds.push(round);
                    remaining = remaining.filter(m => !round.includes(m));
                } else {
                    break;
                }
            }
        }
        
        function validateTournament() {
            if (teams.length < 2) return { valid: false, message: 'Minimum 2 √©quipes' };
            
            const expected = (teams.length * (teams.length - 1)) / 2;
            if (matches.length !== expected) return { valid: false, message: 'Erreur matchs' };
            
            for (let round of matchRounds) {
                const teamsInRound = new Set();
                for (let match of round) {
                    if (teamsInRound.has(match.team1.id) || teamsInRound.has(match.team2.id)) {
                        return { valid: false, message: '√âquipe joue 2x' };
                    }
                    teamsInRound.add(match.team1.id);
                    teamsInRound.add(match.team2.id);
                }
            }
            
            return { valid: true, message: 'OK' };
        }

        function displayCurrentRound() {
            pauseTimer();
            
            const prevBtn = document.getElementById('prevRoundBtn');
            const nextBtn = document.getElementById('nextRoundBtn');
            const endBtn = document.getElementById('endTournamentBtn');
            
            if (currentRound >= matchRounds.length) {
                document.getElementById('currentRoundInfo').innerHTML = '<strong>üèÜ Tournoi termin√© !</strong>';
                document.getElementById('matchesGrid').innerHTML = '';
                prevBtn.style.display = 'inline-block';
                nextBtn.style.display = 'none';
                endBtn.style.display = 'inline-block';
                return;
            }

            prevBtn.style.display = currentRound > 0 ? 'inline-block' : 'none';
            nextBtn.style.display = 'inline-block';
            endBtn.style.display = 'none';
            
            const roundMatches = matchRounds[currentRound];
            document.getElementById('currentRoundInfo').innerHTML = 
                '<strong>Manche ' + (currentRound + 1) + ' sur ' + matchRounds.length + '</strong>';

            const grid = document.getElementById('matchesGrid');
            grid.innerHTML = roundMatches.map(match => {
                let html = '<div class="match-card">';
                html += '<div class="match-header"><span class="match-title">Match ' + match.id + ' - Terrain ' + match.field + '</span></div>';
                html += '<div class="teams-scores">';
                
                html += '<div class="team-score">';
                html += '<div class="team-name">' + match.team1.name + '</div>';
                html += '<div class="score-display">' + match.score1 + '</div>';
                html += '<div class="score-controls">';
                html += '<button class="score-btn" onclick="updateScore(' + match.id + ', 1, -1)">‚àí</button>';
                html += '<input type="number" class="score-input" value="' + match.score1 + '" onchange="setScore(' + match.id + ', 1, this.value)" min="0">';
                html += '<button class="score-btn" onclick="updateScore(' + match.id + ', 1, 1)">+</button>';
                html += '</div>';
                
                if (enableTurnovers) {
                    html += '<div style="margin-top:15px;padding-top:15px;border-top:1px solid #eee">';
                    html += '<div style="font-size:0.9em;color:#666;margin-bottom:5px">Pertes de disque</div>';
                    html += '<div class="score-display" style="font-size:2em;color:#e74c3c">' + match.turnovers1 + '</div>';
                    html += '<div class="score-controls">';
                    html += '<button class="score-btn" onclick="updateTurnovers(' + match.id + ', 1, -1)">‚àí</button>';
                    html += '<input type="number" class="score-input" value="' + match.turnovers1 + '" onchange="setTurnovers(' + match.id + ', 1, this.value)" min="0">';
                    html += '<button class="score-btn" onclick="updateTurnovers(' + match.id + ', 1, 1)">+</button>';
                    html += '</div></div>';
                }
                html += '</div>';
                
                html += '<div class="vs">VS</div>';
                
                html += '<div class="team-score">';
                html += '<div class="team-name">' + match.team2.name + '</div>';
                html += '<div class="score-display">' + match.score2 + '</div>';
                html += '<div class="score-controls">';
                html += '<button class="score-btn" onclick="updateScore(' + match.id + ', 2, -1)">‚àí</button>';
                html += '<input type="number" class="score-input" value="' + match.score2 + '" onchange="setScore(' + match.id + ', 2, this.value)" min="0">';
                html += '<button class="score-btn" onclick="updateScore(' + match.id + ', 2, 1)">+</button>';
                html += '</div>';
                
                if (enableTurnovers) {
                    html += '<div style="margin-top:15px;padding-top:15px;border-top:1px solid #eee">';
                    html += '<div style="font-size:0.9em;color:#666;margin-bottom:5px">Pertes de disque</div>';
                    html += '<div class="score-display" style="font-size:2em;color:#e74c3c">' + match.turnovers2 + '</div>';
                    html += '<div class="score-controls">';
                    html += '<button class="score-btn" onclick="updateTurnovers(' + match.id + ', 2, -1)">‚àí</button>';
                    html += '<input type="number" class="score-input" value="' + match.turnovers2 + '" onchange="setTurnovers(' + match.id + ', 2, this.value)" min="0">';
                    html += '<button class="score-btn" onclick="updateTurnovers(' + match.id + ', 2, 1)">+</button>';
                    html += '</div></div>';
                }
                html += '</div>';
                html += '</div>';
                
                if (enableBadges) {
                    html += '<div class="badge-section"><div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">';
                    html += '<div style="text-align:center"><div style="font-weight:bold;margin-bottom:10px">Badge ' + match.team1.name + '</div>';
                    html += '<div class="badge-status ' + (isBadgeValidated(match, 1) ? 'badge-validated' : 'badge-pending') + '">';
                    html += isBadgeValidated(match, 1) ? '‚úì Valid√©' : '‚è≥ Non valid√©';
                    html += '</div></div>';
                    html += '<div style="text-align:center"><div style="font-weight:bold;margin-bottom:10px">Badge ' + match.team2.name + '</div>';
                    html += '<div class="badge-status ' + (isBadgeValidated(match, 2) ? 'badge-validated' : 'badge-pending') + '">';
                    html += isBadgeValidated(match, 2) ? '‚úì Valid√©' : '‚è≥ Non valid√©';
                    html += '</div></div>';
                    html += '</div></div>';
                }
                
                if (enableHuddle) {
                    html += '<div class="badge-section" style="border-top:2px solid #eee;padding-top:15px">';
                    html += '<h4 style="text-align:center;color:#667eea;margin-bottom:15px">Notes Huddle</h4>';
                    html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">';
                    html += '<div style="text-align:center"><div style="font-weight:bold;margin-bottom:10px">' + match.team1.name + ' not√©e</div>';
                    html += '<div style="display:flex;align-items:center;justify-content:center;gap:10px">';
                    html += '<button class="score-btn" onclick="updateHuddle(' + match.id + ', 1, -1)">‚àí</button>';
                    html += '<input type="number" class="score-input" value="' + match.huddle1 + '" onchange="setHuddle(' + match.id + ', 1, this.value)" min="0" max="9" style="width:60px">';
                    html += '<button class="score-btn" onclick="updateHuddle(' + match.id + ', 1, 1)">+</button>';
                    html += '<span>/9</span></div></div>';
                    html += '<div style="text-align:center"><div style="font-weight:bold;margin-bottom:10px">' + match.team2.name + ' not√©e</div>';
                    html += '<div style="display:flex;align-items:center;justify-content:center;gap:10px">';
                    html += '<button class="score-btn" onclick="updateHuddle(' + match.id + ', 2, -1)">‚àí</button>';
                    html += '<input type="number" class="score-input" value="' + match.huddle2 + '" onchange="setHuddle(' + match.id + ', 2, this.value)" min="0" max="9" style="width:60px">';
                    html += '<button class="score-btn" onclick="updateHuddle(' + match.id + ', 2, 1)">+</button>';
                    html += '<span>/9</span></div></div>';
                    html += '</div></div>';
                }
                
                html += '</div>';
                return html;
            }).join('');
            
            resetTimer();
        }

        function isBadgeValidated(match, teamNum) {
            if (!enableBadges) return false;
            
            const score = teamNum === 1 ? match.score1 : match.score2;
            const turnovers = teamNum === 1 ? match.turnovers1 : match.turnovers2;
            
            if (badgeType === 'points') {
                return score >= badgePoints;
            } else {
                const total = score + turnovers;
                if (total === 0) return false;
                return ((score / total) * 100) >= badgeEfficiency;
            }
        }

        function previousRound() {
            if (currentRound > 0) {
                currentRound--;
                displayCurrentRound();
            }
        }

        function nextRound() {
            if (currentRound < matchRounds.length) {
                currentRound++;
                displayCurrentRound();
            }
        }

        function endTournament() {
            teams = [];
            matches = [];
            currentRound = 0;
            matchRounds = [];
            pauseTimer();
            
            document.getElementById('setupSection').classList.remove('hidden');
            document.getElementById('matchesSection').classList.add('hidden');
            document.getElementById('rankingSection').classList.add('hidden');
            displayTeams();
        }

        function updateScore(matchId, teamNum, change) {
            const match = matches.find(m => m.id === matchId);
            if (teamNum === 1) {
                match.score1 = Math.max(0, match.score1 + change);
            } else {
                match.score2 = Math.max(0, match.score2 + change);
            }
            displayCurrentRound();
            updateRanking();
        }

        function setScore(matchId, teamNum, value) {
            const match = matches.find(m => m.id === matchId);
            const score = Math.max(0, parseInt(value) || 0);
            if (teamNum === 1) {
                match.score1 = score;
            } else {
                match.score2 = score;
            }
            displayCurrentRound();
            updateRanking();
        }

        function updateTurnovers(matchId, teamNum, change) {
            const match = matches.find(m => m.id === matchId);
            if (teamNum === 1) {
                match.turnovers1 = Math.max(0, match.turnovers1 + change);
            } else {
                match.turnovers2 = Math.max(0, match.turnovers2 + change);
            }
            displayCurrentRound();
            updateRanking();
        }

        function setTurnovers(matchId, teamNum, value) {
            const match = matches.find(m => m.id === matchId);
            const turnovers = Math.max(0, parseInt(value) || 0);
            if (teamNum === 1) {
                match.turnovers1 = turnovers;
            } else {
                match.turnovers2 = turnovers;
            }
            displayCurrentRound();
            updateRanking();
        }

        function updateHuddle(matchId, teamNum, change) {
            const match = matches.find(m => m.id === matchId);
            if (teamNum === 1) {
                match.huddle1 = Math.max(0, Math.min(9, match.huddle1 + change));
            } else {
                match.huddle2 = Math.max(0, Math.min(9, match.huddle2 + change));
            }
            displayCurrentRound();
            updateRanking();
        }

        function setHuddle(matchId, teamNum, value) {
            const match = matches.find(m => m.id === matchId);
            const huddle = Math.max(0, Math.min(9, parseInt(value) || 0));
            if (teamNum === 1) {
                match.huddle1 = huddle;
            } else {
                match.huddle2 = huddle;
            }
            displayCurrentRound();
            updateRanking();
        }

        function updateRanking() {
            teams.forEach(team => {
                team.wins = 0;
                team.losses = 0;
                team.pointsFor = 0;
                team.pointsAgainst = 0;
                team.turnovers = 0;
                team.badges = 0;
                team.huddleTotal = 0;
                team.huddleCount = 0;
            });

            matches.forEach(match => {
                const team1 = teams.find(t => t.id === match.team1.id);
                const team2 = teams.find(t => t.id === match.team2.id);

                if (!team1 || !team2) return;

                team1.pointsFor += match.score1;
                team1.pointsAgainst += match.score2;
                team1.turnovers += match.turnovers1;
                
                team2.pointsFor += match.score2;
                team2.pointsAgainst += match.score1;
                team2.turnovers += match.turnovers2;

                if (match.score1 > match.score2) {
                    team1.wins++;
                    team2.losses++;
                } else if (match.score2 > match.score1) {
                    team2.wins++;
                    team1.losses++;
                }

                if (enableBadges) {
                    if (isBadgeValidated(match, 1)) team1.badges++;
                    if (isBadgeValidated(match, 2)) team2.badges++;
                }
                
                if (enableHuddle) {
                    if (match.huddle1 > 0) {
                        team1.huddleTotal += match.huddle1;
                        team1.huddleCount++;
                    }
                    if (match.huddle2 > 0) {
                        team2.huddleTotal += match.huddle2;
                        team2.huddleCount++;
                    }
                }
            });

            const sorted = [...teams].sort((a, b) => {
                if (b.wins !== a.wins) return b.wins - a.wins;
                return (b.pointsFor - b.pointsAgainst) - (a.pointsFor - a.pointsAgainst);
            });

            const tbody = document.getElementById('rankingBody');
            tbody.innerHTML = sorted.map(team => {
                const total = team.pointsFor + team.turnovers;
                const eff = total > 0 ? ((team.pointsFor / total) * 100).toFixed(1) : '0.0';
                const huddle = team.huddleCount > 0 ? (team.huddleTotal / team.huddleCount).toFixed(2) : '-';
                
                let row = '<tr><td>' + team.name + '</td><td>' + team.wins + '</td>';
                if (enableTurnovers) row += '<td><strong>' + eff + '%</strong></td>';
                if (enableBadges) row += '<td>' + team.badges + '</td>';
                if (enableHuddle) row += '<td><strong>' + huddle + '</strong></td>';
                row += '</tr>';
                return row;
            }).join('');
        }

        function startTimer() {
            if (!timerRunning) {
                if (remainingTime === 0) remainingTime = matchDuration * 60;
                timerRunning = true;
                document.getElementById('startTimerBtn').style.display = 'none';
                document.getElementById('pauseTimerBtn').style.display = 'inline-block';
                document.getElementById('timerStatus').textContent = 'Match en cours';
                
                timerInterval = setInterval(() => {
                    if (remainingTime > 0) {
                        remainingTime--;
                        updateTimerDisplay();
                    } else {
                        pauseTimer();
                        document.getElementById('timerStatus').textContent = '‚è∞ Temps √©coul√© !';
                        alert('Temps √©coul√© !');
                    }
                }, 1000);
            }
        }

        function pauseTimer() {
            if (timerRunning) {
                timerRunning = false;
                clearInterval(timerInterval);
                document.getElementById('startTimerBtn').style.display = 'inline-block';
                document.getElementById('pauseTimerBtn').style.display = 'none';
                document.getElementById('timerStatus').textContent = 'Match en pause';
            }
        }

        function resetTimer() {
            pauseTimer();
            remainingTime = matchDuration * 60;
            updateTimerDisplay();
            document.getElementById('timerStatus').textContent = 'Chronom√®tre pr√™t';
        }

        function updateTimerDisplay() {
            const min = Math.floor(remainingTime / 60);
            const sec = remainingTime % 60;
            const display = min.toString().padStart(2, '0') + ':' + sec.toString().padStart(2, '0');
            
            const timer = document.getElementById('timerDisplay');
            timer.textContent = display;
            timer.classList.remove('warning', 'danger');
            if (remainingTime <= 60) timer.classList.add('danger');
            else if (remainingTime <= 180) timer.classList.add('warning');
        }

        document.getElementById('teamNameInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') addTeam();
        });

        function exportClassement() {
            // Calculer les stats finales
            teams.forEach(team => {
                team.wins = 0;
                team.losses = 0;
                team.pointsFor = 0;
                team.pointsAgainst = 0;
                team.turnovers = 0;
                team.badges = 0;
                team.huddleTotal = 0;
                team.huddleCount = 0;
            });

            matches.forEach(match => {
                const team1 = teams.find(t => t.id === match.team1.id);
                const team2 = teams.find(t => t.id === match.team2.id);

                if (!team1 || !team2) return;

                team1.pointsFor += match.score1;
                team1.pointsAgainst += match.score2;
                team1.turnovers += match.turnovers1;
                
                team2.pointsFor += match.score2;
                team2.pointsAgainst += match.score1;
                team2.turnovers += match.turnovers2;

                if (match.score1 > match.score2) {
                    team1.wins++;
                    team2.losses++;
                } else if (match.score2 > match.score1) {
                    team2.wins++;
                    team1.losses++;
                }

                if (enableBadges) {
                    if (isBadgeValidated(match, 1)) team1.badges++;
                    if (isBadgeValidated(match, 2)) team2.badges++;
                }
                
                if (enableHuddle) {
                    if (match.huddle1 > 0) {
                        team1.huddleTotal += match.huddle1;
                        team1.huddleCount++;
                    }
                    if (match.huddle2 > 0) {
                        team2.huddleTotal += match.huddle2;
                        team2.huddleCount++;
                    }
                }
            });

            // Trier les √©quipes
            const sorted = [...teams].sort((a, b) => {
                if (b.wins !== a.wins) return b.wins - a.wins;
                return (b.pointsFor - b.pointsAgainst) - (a.pointsFor - a.pointsAgainst);
            });

            // Cr√©er le classeur Excel
            const wb = XLSX.utils.book_new();
            
            // Pr√©parer les donn√©es
            const header = ['√âquipe', 'Victoires'];
            if (enableTurnovers) header.push('% Efficacit√©');
            if (enableBadges) header.push('Badges valid√©s');
            if (enableHuddle) header.push('Moyenne Huddle');
            
            const data = [
                ['CLASSEMENT FINAL - TOURNOI ULTIMATE'],
                [],
                header
            ];
            
            sorted.forEach(team => {
                const row = [team.name, team.wins];
                
                if (enableTurnovers) {
                    const total = team.pointsFor + team.turnovers;
                    const eff = total > 0 ? parseFloat(((team.pointsFor / total) * 100).toFixed(1)) : 0;
                    row.push(eff);
                }
                
                if (enableBadges) {
                    row.push(team.badges);
                }
                
                if (enableHuddle) {
                    const huddle = team.huddleCount > 0 ? parseFloat((team.huddleTotal / team.huddleCount).toFixed(2)) : 0;
                    row.push(huddle);
                }
                
                data.push(row);
            });
            
            // Cr√©er la feuille
            const ws = XLSX.utils.aoa_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, 'Classement');
            
            // G√©n√©rer le nom du fichier avec date et heure
            const date = new Date();
            const dateStr = date.getFullYear() + '-' + 
                           (date.getMonth() + 1).toString().padStart(2, '0') + '-' + 
                           date.getDate().toString().padStart(2, '0');
            const timeStr = date.getHours().toString().padStart(2, '0') + 'h' + 
                           date.getMinutes().toString().padStart(2, '0');
            
            // T√©l√©charger le fichier
            XLSX.writeFile(wb, 'classement_ultimate_' + dateStr + '_' + timeStr + '.xlsx');
        }
    </script>
</body>
</html>