<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü•è Tournoi d'Ultimate - EPS</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 30px;
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #764ba2;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-warning {
            background: #ff9800;
            color: white;
        }

        .btn-warning:hover {
            background: #f57c00;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }

        .team-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .team-badge {
            background: #667eea;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .team-badge button {
            background: white;
            color: #667eea;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-left: 30px;
            margin-top: 10px;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: normal;
        }

        .sub-option {
            margin-left: 30px;
            margin-top: 10px;
        }

        .match-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        .match-header {
            text-align: center;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
            margin-bottom: 20px;
        }

        .match-header h3 {
            color: #667eea;
            font-size: 1.3em;
        }

        .match-grid {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            align-items: start;
        }

        .team-section {
            text-align: center;
        }

        .team-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }

        .score-display {
            font-size: 3em;
            color: #667eea;
            font-weight: bold;
            margin: 10px 0;
        }

        .score-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 10px 0;
        }

        .score-controls button {
            width: 40px;
            height: 40px;
            font-size: 20px;
            border-radius: 50%;
        }

        .score-controls input {
            width: 80px;
            text-align: center;
            font-size: 18px;
        }

        .vs-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }

        .vs-text {
            font-size: 2em;
            font-weight: bold;
            color: #764ba2;
        }

        .timer {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .timer-display {
            font-size: 3em;
            font-weight: bold;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
        }

        .timer-display.normal {
            color: #667eea;
        }

        .timer-display.warning {
            color: #ff9800;
        }

        .timer-display.danger {
            color: #dc3545;
        }

        .timer-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .losses-display {
            font-size: 2em;
            color: #dc3545;
            margin: 10px 0;
        }

        .badge-status {
            margin: 10px 0;
            padding: 8px;
            border-radius: 5px;
            font-weight: bold;
        }

        .badge-validated {
            background: #d4edda;
            color: #155724;
        }

        .badge-pending {
            background: #fff3cd;
            color: #856404;
        }

        .huddle-section {
            margin-top: 15px;
        }

        .huddle-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .huddle-display {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            gap: 10px;
            flex-wrap: wrap;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .referee-info {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        .hidden {
            display: none;
        }

        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            h1 {
                font-size: 1.8em;
            }

            .match-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .vs-section {
                order: -1;
            }

            .score-display {
                font-size: 2em;
            }

            .timer-display {
                font-size: 2em;
            }

            .navigation {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }

        .rotation-header {
            text-align: center;
            font-size: 2em;
            color: #667eea;
            margin: 30px 0 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .global-timer {
            text-align: center;
            padding: 30px;
            background: white;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .global-timer-display {
            font-size: 4em;
            font-weight: bold;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
        }

        .ranking-section {
            margin-top: 50px;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .ranking-section h2 {
            text-align: center;
            color: #667eea;
            margin-bottom: 20px;
        }

        .final-page {
            text-align: center;
        }

        .final-page h1 {
            font-size: 3em;
            margin-bottom: 30px;
        }

        .final-page .btn {
            margin: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü•è Tournoi d'Ultimate - EPS</h1>

        <!-- Configuration Page -->
        <div id="configPage">
            <div class="section">
                <h2>Configuration du Tournoi</h2>
                
                <div class="form-group">
                    <label>Nombre d'√©quipes (2-10) :</label>
                    <input type="number" id="numTeams" min="2" max="10" value="4">
                </div>

                <div class="form-group">
                    <label>Nombre de terrains :</label>
                    <select id="numFields">
                        <option value="1">1 terrain</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Dur√©e des matchs (minutes) :</label>
                    <input type="number" id="matchDuration" min="1" max="60" value="10">
                </div>
            </div>

            <div class="section">
                <h2>Options du Tournoi</h2>

                <div class="checkbox-group">
                    <input type="checkbox" id="enableLosses">
                    <label for="enableLosses" style="display: inline;">Activer les pertes de disque</label>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="enableBadges">
                    <label for="enableBadges" style="display: inline;">Activer la validation des badges</label>
                </div>

                <div id="badgeOptions" class="sub-option hidden">
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="badgeMode" value="points" checked>
                            Par nombre de points :
                            <input type="number" id="badgePoints" min="1" value="4" style="width: 80px; display: inline-block; margin-left: 5px;">
                        </label>
                        <label>
                            <input type="radio" name="badgeMode" value="efficiency">
                            Par % d'efficacit√© :
                            <input type="number" id="badgeEfficiency" min="1" max="100" value="70" style="width: 80px; display: inline-block; margin-left: 5px;">%
                        </label>
                    </div>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="enableHuddle">
                    <label for="enableHuddle" style="display: inline;">Activer les notes Huddle (Fair-Play)</label>
                </div>
            </div>

            <div class="section">
                <h2>Gestion des √âquipes</h2>
                <div class="input-group">
                    <input type="text" id="teamNameInput" placeholder="Nom de l'√©quipe">
                    <button class="btn btn-primary" onclick="addTeam()">Ajouter</button>
                </div>
                <div class="team-list" id="teamList"></div>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-success" onclick="startTournament()" style="font-size: 1.2em; padding: 15px 40px;">
                    üöÄ D√©marrer le Tournoi
                </button>
            </div>
        </div>

        <!-- Tournament Page -->
        <div id="tournamentPage" class="hidden">
            <div id="matchesContainer"></div>

            <!-- Ranking Section (always visible) -->
            <div class="ranking-section" id="liveRanking">
                <h2>üìä Classement en Direct</h2>
                <div id="liveRankingTable"></div>
            </div>

            <div class="navigation">
                <button class="btn btn-primary" id="prevBtn" onclick="previousRotation()">‚Üê Rotation pr√©c√©dente</button>
                <button class="btn btn-warning" id="nextBtn" onclick="nextRotation()">Rotation suivante ‚Üí</button>
                <button class="btn btn-danger hidden" id="finishBtn" onclick="finishTournament()">üèÅ Terminer le tournoi</button>
            </div>
        </div>

        <!-- Final Ranking Page -->
        <div id="finalPage" class="hidden">
            <div class="final-page">
                <h1>üèÜ Classement Final</h1>
                <div id="finalRankingTable"></div>
                <div style="margin-top: 40px;">
                    <button class="btn btn-info" onclick="exportRanking()" style="font-size: 1.2em; padding: 15px 30px;">üìä Exporter le classement (Excel)</button>
                    <button class="btn btn-primary" onclick="backToConfig()" style="font-size: 1.2em; padding: 15px 30px;">üîÑ Nouveau tournoi</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let teams = [];
        let matches = [];
        let currentRotation = 0;
        let config = {
            numFields: 1,
            matchDuration: 10,
            enableLosses: false,
            enableBadges: false,
            badgeMode: 'points',
            badgePoints: 4,
            badgeEfficiency: 70,
            enableHuddle: false
        };
        let globalTimer = {
            timeRemaining: 0,
            interval: null,
            running: false
        };

        // Update field selection based on number of teams
        document.getElementById('numTeams').addEventListener('change', function() {
            updateFieldOptions();
        });

        function updateFieldOptions() {
            const numTeams = parseInt(document.getElementById('numTeams').value);
            const select = document.getElementById('numFields');
            select.innerHTML = '';

            let maxFields = 1;
            if (numTeams <= 3) maxFields = 1;
            else if (numTeams <= 5) maxFields = 2;
            else if (numTeams <= 7) maxFields = 3;
            else if (numTeams <= 9) maxFields = 4;
            else if (numTeams === 10) maxFields = 5;

            for (let i = 1; i <= maxFields; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i + (i === 1 ? ' terrain' : ' terrains');
                select.appendChild(option);
            }
        }

        // Badge options toggle
        document.getElementById('enableBadges').addEventListener('change', function() {
            document.getElementById('badgeOptions').classList.toggle('hidden', !this.checked);
        });

        // Team management
        document.getElementById('teamNameInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addTeam();
            }
        });

        function addTeam() {
            const input = document.getElementById('teamNameInput');
            const teamName = input.value.trim();

            if (!teamName) {
                alert('Veuillez entrer un nom d\'√©quipe');
                return;
            }

            if (teams.some(t => t.name === teamName)) {
                alert('Cette √©quipe existe d√©j√†');
                return;
            }

            if (teams.length >= 10) {
                alert('Maximum 10 √©quipes');
                return;
            }

            teams.push({
                name: teamName,
                wins: 0,
                points: 0,
                losses: 0,
                huddleScores: [],
                badgesValidated: 0
            });

            input.value = '';
            renderTeamList();
        }

        function removeTeam(index) {
            teams.splice(index, 1);
            renderTeamList();
        }

        function renderTeamList() {
            const list = document.getElementById('teamList');
            list.innerHTML = teams.map((team, i) => `
                <div class="team-badge">
                    ${team.name}
                    <button onclick="removeTeam(${i})">√ó</button>
                </div>
            `).join('');
        }

        // Tournament generation
        function generateMatches(teamList, numFields) {
            const n = teamList.length;
            const allMatches = [];

            // Generate all possible matches
            for (let i = 0; i < n; i++) {
                for (let j = i + 1; j < n; j++) {
                    allMatches.push([i, j]);
                }
            }

            // Organize by rotations based on predefined algorithms
            if (numFields === 1) {
                return organizeOneField(allMatches, n);
            } else {
                return organizeMultipleFields(teamList, numFields);
            }
        }

        function organizeOneField(allMatches, n) {
            const rotations = [];
            const used = new Set();
            let lastTeam = -1;

            for (const match of allMatches) {
                const [t1, t2] = match;
                if (t1 !== lastTeam && t2 !== lastTeam) {
                    rotations.push([match]);
                    lastTeam = t2;
                }
            }

            // Add remaining matches
            for (const match of allMatches) {
                const matchStr = match.join('-');
                if (!rotations.some(r => r.some(m => m.join('-') === matchStr))) {
                    let placed = false;
                    for (let rotation of rotations) {
                        const teamsInRotation = new Set(rotation.flat());
                        if (!teamsInRotation.has(match[0]) && !teamsInRotation.has(match[1])) {
                            rotation.push(match);
                            placed = true;
                            break;
                        }
                    }
                    if (!placed) {
                        rotations.push([match]);
                    }
                }
            }

            return rotations;
        }

        function organizeMultipleFields(teamList, numFields) {
            const n = teamList.length;
            const patterns = {
                '4-2': [[0,1,2,3],[1,3,0,2],[1,2,0,3]],
                '5-2': [[0,1,2,3],[0,4,1,2],[3,4,0,2],[1,3,2,4],[0,3,1,4]],
                '6-3': [[0,1,2,3,4,5],[3,5,1,4,0,2],[2,4,1,5,0,3],[2,5,1,3,0,4],[3,4,1,2,0,5]],
                '7-3': [[0,1,2,3,4,5],[0,6,1,2,3,4],[5,6,0,2,1,3],[4,6,0,5,1,4],[1,6,0,4,2,5],[1,5,0,3,4,6],[2,6]],
                '8-4': [[0,1,2,3,4,5,6,7],[5,7,4,6,1,3,0,2],[5,6,4,7,1,2,0,3],[3,7,2,6,1,5,0,4],[3,6,2,7,1,4,0,5],[3,5,2,4,1,7,0,6],[3,4,2,5,1,6,0,7]],
                '9-4': [[0,1,2,3,4,5,6,7],[0,8,1,2,3,4,5,6],[7,8,0,2,1,3,4,6],[5,7,1,8,0,3,2,4],[6,8,0,5,1,7,2,5],[2,8,0,4,1,5,3,7],[0,6,3,8,1,4,2,7],[5,8,1,6,0,7,2,6],[2,6,3,5,4,8]],
                '10-5': [[0,1,2,3,4,5,6,7,8,9],[7,9,5,8,4,6,1,3,0,2],[6,8,5,9,4,7,1,2,0,3],[7,8,3,9,2,6,1,5,0,4],[6,9,3,8,2,7,1,4,0,5],[4,9,3,5,2,8,1,7,0,6],[5,6,3,4,2,9,1,8,0,7],[5,7,3,6,2,4,1,9,0,8],[4,8,3,7,2,5,1,6,0,9]]
            };

            const key = `${n}-${numFields}`;
            const pattern = patterns[key];

            if (!pattern) {
                // Fallback to simple organization
                return organizeOneField(generateAllMatches(n), n);
            }

            const rotations = [];
            for (const rotation of pattern) {
                const matches = [];
                for (let i = 0; i < rotation.length; i += 2) {
                    if (i + 1 < rotation.length) {
                        matches.push([rotation[i], rotation[i + 1]]);
                    }
                }
                if (matches.length > 0) {
                    rotations.push(matches);
                }
            }

            return rotations;
        }

        function generateAllMatches(n) {
            const matches = [];
            for (let i = 0; i < n; i++) {
                for (let j = i + 1; j < n; j++) {
                    matches.push([i, j]);
                }
            }
            return matches;
        }

        function startTournament() {
            if (teams.length < 2) {
                alert('Minimum 2 √©quipes requises');
                return;
            }

            // Save configuration
            config.numFields = parseInt(document.getElementById('numFields').value);
            config.matchDuration = parseInt(document.getElementById('matchDuration').value);
            config.enableLosses = document.getElementById('enableLosses').checked;
            config.enableBadges = document.getElementById('enableBadges').checked;
            
            const badgeModeRadio = document.querySelector('input[name="badgeMode"]:checked');
            config.badgeMode = badgeModeRadio ? badgeModeRadio.value : 'points';
            config.badgePoints = parseInt(document.getElementById('badgePoints').value) || 4;
            config.badgeEfficiency = parseInt(document.getElementById('badgeEfficiency').value) || 70;
            config.enableHuddle = document.getElementById('enableHuddle').checked;

            // Generate matches
            const rotations = generateMatches(teams, config.numFields);
            
            // Create match objects
            matches = [];
            let matchId = 1;
            rotations.forEach((rotation, rotIndex) => {
                rotation.forEach((match, fieldIndex) => {
                    matches.push({
                        id: matchId++,
                        rotation: rotIndex,
                        field: fieldIndex + 1,
                        team1: match[0],
                        team2: match[1],
                        score1: 0,
                        score2: 0,
                        losses1: 0,
                        losses2: 0,
                        huddle1: 0,
                        huddle2: 0
                    });
                });
            });

            // Get referee teams
            assignReferees();

            // Confirm and start
            if (matches.length === 0) {
                alert('Erreur lors de la g√©n√©ration des matchs');
                return;
            }
            
            const numRotations = Math.max(...matches.map(m => m.rotation)) + 1;
            if (confirm(`Le tournoi est pr√™t !\n\nNombre de rotations : ${numRotations}\nNombre de matchs : ${matches.length}\n\nVoulez-vous d√©marrer ?`)) {
                document.getElementById('configPage').classList.add('hidden');
                document.getElementById('tournamentPage').classList.remove('hidden');
                currentRotation = 0;
                globalTimer.timeRemaining = config.matchDuration * 60;
                renderMatches();
            }
        }

        function assignReferees() {
            matches.forEach(match => {
                const teamsInRotation = matches
                    .filter(m => m.rotation === match.rotation)
                    .flatMap(m => [m.team1, m.team2]);
                
                const availableReferees = teams
                    .map((t, i) => i)
                    .filter(i => !teamsInRotation.includes(i));
                
                match.referees = availableReferees;
            });
        }

        function renderMatches() {
            const container = document.getElementById('matchesContainer');
            const rotationMatches = matches.filter(m => m.rotation === currentRotation);

            if (rotationMatches.length === 0) {
                container.innerHTML = '<p>Aucun match dans cette rotation</p>';
                return;
            }

            const maxRotation = Math.max(...matches.map(m => m.rotation));

            container.innerHTML = `
                <div class="rotation-header">
                    Rotation ${currentRotation + 1} / ${maxRotation + 1}
                </div>

                <!-- Global Timer -->
                <div class="global-timer">
                    <h2 style="color: #667eea; margin-bottom: 10px;">‚è±Ô∏è Chronom√®tre de la Rotation</h2>
                    <div class="timer-display global-timer-display normal" id="globalTimer">
                        ${formatTime(globalTimer.timeRemaining)}
                    </div>
                    <div class="timer-controls">
                        <button class="btn btn-success" onclick="startGlobalTimer()" style="font-size: 1.1em;">‚ñ∂ D√©but du match</button>
                        <button class="btn btn-warning" onclick="pauseGlobalTimer()" style="font-size: 1.1em;">‚è∏ Pause</button>
                        <button class="btn btn-info" onclick="resetGlobalTimer()" style="font-size: 1.1em;">‚ü≤ R√©initialiser</button>
                    </div>
                </div>

                ${rotationMatches.map(match => renderMatchCard(match)).join('')}
            `;

            // Update navigation buttons
            document.getElementById('prevBtn').classList.toggle('hidden', currentRotation === 0);
            document.getElementById('nextBtn').classList.toggle('hidden', currentRotation === maxRotation);
            document.getElementById('finishBtn').classList.toggle('hidden', currentRotation !== maxRotation);

            // Update live ranking
            updateLiveRanking();
        }

        function renderMatchCard(match) {
            const team1 = teams[match.team1];
            const team2 = teams[match.team2];
            const referees = match.referees?.map(r => teams[r].name).join(', ') || 'Aucun';

            return `
                <div class="match-card">
                    <div class="match-header">
                        <h3>Match ${match.id} - Terrain ${match.field}</h3>
                        <div class="referee-info">üëÅÔ∏è Arbitres : ${referees}</div>
                    </div>

                    <div class="match-grid">
                        <!-- Team 1 -->
                        <div class="team-section">
                            <div class="team-name">${team1.name}</div>
                            <div class="score-display" id="score1-${match.id}">${match.score1}</div>
                            <div class="score-controls">
                                <button class="btn btn-danger" onclick="updateScore(${match.id}, 1, -1)">-</button>
                                <input type="number" min="0" value="${match.score1}" 
                                       onchange="setScore(${match.id}, 1, this.value)">
                                <button class="btn btn-success" onclick="updateScore(${match.id}, 1, 1)">+</button>
                            </div>

                            ${config.enableLosses ? `
                                <div class="losses-display" id="losses1-${match.id}">${match.losses1}</div>
                                <div style="font-size: 0.9em; color: #dc3545; margin-bottom: 5px;">Pertes de disque</div>
                                <div class="score-controls">
                                    <button class="btn btn-danger" onclick="updateLosses(${match.id}, 1, -1)">-</button>
                                    <input type="number" min="0" value="${match.losses1}" 
                                           onchange="setLosses(${match.id}, 1, this.value)">
                                    <button class="btn btn-danger" onclick="updateLosses(${match.id}, 1, 1)">+</button>
                                </div>
                            ` : ''}

                            ${config.enableBadges ? `
                                <div class="badge-status ${getBadgeStatus(match, 1).validated ? 'badge-validated' : 'badge-pending'}" 
                                     id="badge1-${match.id}">
                                    ${getBadgeStatus(match, 1).text}
                                </div>
                            ` : ''}

                            ${config.enableHuddle ? `
                                <div class="huddle-section">
                                    <div>Note Huddle pour ${team2.name}</div>
                                    <div class="huddle-controls">
                                        <button class="btn btn-primary" onclick="updateHuddle(${match.id}, 1, -1)">-</button>
                                        <div class="huddle-display" id="huddle1-${match.id}">${match.huddle1}/9</div>
                                        <button class="btn btn-primary" onclick="updateHuddle(${match.id}, 1, 1)">+</button>
                                    </div>
                                    <input type="number" min="0" max="9" value="${match.huddle1}" 
                                           onchange="setHuddle(${match.id}, 1, this.value)"
                                           style="width: 80px; text-align: center; margin-top: 5px;">
                                </div>
                            ` : ''}
                        </div>

                        <!-- VS Section -->
                        <div class="vs-section">
                            <div class="vs-text">VS</div>
                        </div>

                        <!-- Team 2 -->
                        <div class="team-section">
                            <div class="team-name">${team2.name}</div>
                            <div class="score-display" id="score2-${match.id}">${match.score2}</div>
                            <div class="score-controls">
                                <button class="btn btn-danger" onclick="updateScore(${match.id}, 2, -1)">-</button>
                                <input type="number" min="0" value="${match.score2}" 
                                       onchange="setScore(${match.id}, 2, this.value)">
                                <button class="btn btn-success" onclick="updateScore(${match.id}, 2, 1)">+</button>
                            </div>

                            ${config.enableLosses ? `
                                <div class="losses-display" id="losses2-${match.id}">${match.losses2}</div>
                                <div style="font-size: 0.9em; color: #dc3545; margin-bottom: 5px;">Pertes de disque</div>
                                <div class="score-controls">
                                    <button class="btn btn-danger" onclick="updateLosses(${match.id}, 2, -1)">-</button>
                                    <input type="number" min="0" value="${match.losses2}" 
                                           onchange="setLosses(${match.id}, 2, this.value)">
                                    <button class="btn btn-danger" onclick="updateLosses(${match.id}, 2, 1)">+</button>
                                </div>
                            ` : ''}

                            ${config.enableBadges ? `
                                <div class="badge-status ${getBadgeStatus(match, 2).validated ? 'badge-validated' : 'badge-pending'}" 
                                     id="badge2-${match.id}">
                                    ${getBadgeStatus(match, 2).text}
                                </div>
                            ` : ''}

                            ${config.enableHuddle ? `
                                <div class="huddle-section">
                                    <div>Note Huddle pour ${team1.name}</div>
                                    <div class="huddle-controls">
                                        <button class="btn btn-primary" onclick="updateHuddle(${match.id}, 2, -1)">-</button>
                                        <div class="huddle-display" id="huddle2-${match.id}">${match.huddle2}/9</div>
                                        <button class="btn btn-primary" onclick="updateHuddle(${match.id}, 2, 1)">+</button>
                                    </div>
                                    <input type="number" min="0" max="9" value="${match.huddle2}" 
                                           onchange="setHuddle(${match.id}, 2, this.value)"
                                           style="width: 80px; text-align: center; margin-top: 5px;">
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function getBadgeStatus(match, team) {
            const score = team === 1 ? match.score1 : match.score2;
            const losses = team === 1 ? match.losses1 : match.losses2;

            if (config.badgeMode === 'points') {
                const validated = score >= config.badgePoints;
                return {
                    validated,
                    text: validated ? '‚úì Badge Valid√©' : '‚è≥ Badge Non Valid√©'
                };
            } else {
                const total = score + losses;
                const efficiency = total > 0 ? (score / total * 100) : 0;
                const validated = efficiency >= config.badgeEfficiency;
                return {
                    validated,
                    text: validated ? '‚úì Badge Valid√©' : '‚è≥ Badge Non Valid√©'
                };
            }
        }

        // Score management
        function updateScore(matchId, team, delta) {
            const match = matches.find(m => m.id === matchId);
            if (!match) return;

            if (team === 1) {
                match.score1 = Math.max(0, match.score1 + delta);
                document.getElementById(`score1-${matchId}`).textContent = match.score1;
            } else {
                match.score2 = Math.max(0, match.score2 + delta);
                document.getElementById(`score2-${matchId}`).textContent = match.score2;
            }

            updateBadgeDisplay(matchId);
            updateLiveRanking();
        }

        function setScore(matchId, team, value) {
            const match = matches.find(m => m.id === matchId);
            if (!match) return;

            const score = Math.max(0, parseInt(value) || 0);
            if (team === 1) {
                match.score1 = score;
                document.getElementById(`score1-${matchId}`).textContent = score;
            } else {
                match.score2 = score;
                document.getElementById(`score2-${matchId}`).textContent = score;
            }

            updateBadgeDisplay(matchId);
            updateLiveRanking();
        }

        function updateLosses(matchId, team, delta) {
            const match = matches.find(m => m.id === matchId);
            if (!match) return;

            if (team === 1) {
                match.losses1 = Math.max(0, match.losses1 + delta);
                document.getElementById(`losses1-${matchId}`).textContent = match.losses1;
            } else {
                match.losses2 = Math.max(0, match.losses2 + delta);
                document.getElementById(`losses2-${matchId}`).textContent = match.losses2;
            }

            updateBadgeDisplay(matchId);
            updateLiveRanking();
        }

        function setLosses(matchId, team, value) {
            const match = matches.find(m => m.id === matchId);
            if (!match) return;

            const losses = Math.max(0, parseInt(value) || 0);
            if (team === 1) {
                match.losses1 = losses;
                document.getElementById(`losses1-${matchId}`).textContent = losses;
            } else {
                match.losses2 = losses;
                document.getElementById(`losses2-${matchId}`).textContent = losses;
            }

            updateBadgeDisplay(matchId);
            updateLiveRanking();
        }

        function updateHuddle(matchId, team, delta) {
            const match = matches.find(m => m.id === matchId);
            if (!match) return;

            if (team === 1) {
                match.huddle1 = Math.max(0, Math.min(9, match.huddle1 + delta));
                document.getElementById(`huddle1-${matchId}`).textContent = `${match.huddle1}/9`;
            } else {
                match.huddle2 = Math.max(0, Math.min(9, match.huddle2 + delta));
                document.getElementById(`huddle2-${matchId}`).textContent = `${match.huddle2}/9`;
            }
        }

        function setHuddle(matchId, team, value) {
            const match = matches.find(m => m.id === matchId);
            if (!match) return;

            const huddle = Math.max(0, Math.min(9, parseInt(value) || 0));
            if (team === 1) {
                match.huddle1 = huddle;
                document.getElementById(`huddle1-${matchId}`).textContent = `${huddle}/9`;
            } else {
                match.huddle2 = huddle;
                document.getElementById(`huddle2-${matchId}`).textContent = `${huddle}/9`;
            }
        }

        function updateBadgeDisplay(matchId) {
            if (!config.enableBadges) return;

            const match = matches.find(m => m.id === matchId);
            if (!match) return;

            for (let team = 1; team <= 2; team++) {
                const status = getBadgeStatus(match, team);
                const element = document.getElementById(`badge${team}-${matchId}`);
                if (element) {
                    element.textContent = status.text;
                    element.className = `badge-status ${status.validated ? 'badge-validated' : 'badge-pending'}`;
                }
            }
        }

        // Global Timer functions
        function startGlobalTimer() {
            if (globalTimer.running) return;

            globalTimer.running = true;
            globalTimer.interval = setInterval(() => {
                globalTimer.timeRemaining--;
                updateGlobalTimerDisplay();

                if (globalTimer.timeRemaining <= 0) {
                    pauseGlobalTimer();
                    alert('Temps √©coul√© pour cette rotation !');
                }
            }, 1000);
        }

        function pauseGlobalTimer() {
            if (globalTimer.interval) {
                clearInterval(globalTimer.interval);
                globalTimer.running = false;
            }
        }

        function resetGlobalTimer() {
            pauseGlobalTimer();
            globalTimer.timeRemaining = config.matchDuration * 60;
            updateGlobalTimerDisplay();
        }

        function updateGlobalTimerDisplay() {
            const element = document.getElementById('globalTimer');
            if (!element) return;

            element.textContent = formatTime(globalTimer.timeRemaining);

            // Update color
            element.className = 'timer-display global-timer-display';
            if (globalTimer.timeRemaining < 60) {
                element.classList.add('danger');
            } else if (globalTimer.timeRemaining < 180) {
                element.classList.add('warning');
            } else {
                element.classList.add('normal');
            }
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Navigation
        function previousRotation() {
            if (currentRotation > 0) {
                pauseGlobalTimer();
                currentRotation--;
                resetGlobalTimer();
                renderMatches();
            }
        }

        function nextRotation() {
            const maxRotation = Math.max(...matches.map(m => m.rotation));
            if (currentRotation < maxRotation) {
                pauseGlobalTimer();
                currentRotation++;
                resetGlobalTimer();
                renderMatches();
            }
        }

        // Live Ranking
        function updateLiveRanking() {
            const ranking = calculateRanking();
            const html = generateRankingTable(ranking);
            document.getElementById('liveRankingTable').innerHTML = html;
        }

        // Ranking
        function calculateRanking() {
            // Reset team stats
            teams.forEach(team => {
                team.wins = 0;
                team.points = 0;
                team.pointsAgainst = 0;
                team.losses = 0;
                team.huddleScores = [];
                team.badgesValidated = 0;
            });

            // Calculate from matches
            matches.forEach(match => {
                const team1 = teams[match.team1];
                const team2 = teams[match.team2];

                team1.points += match.score1;
                team1.pointsAgainst += match.score2;
                team2.points += match.score2;
                team2.pointsAgainst += match.score1;

                if (match.score1 > match.score2) {
                    team1.wins++;
                } else if (match.score2 > match.score1) {
                    team2.wins++;
                }

                if (config.enableLosses) {
                    team1.losses += match.losses1;
                    team2.losses += match.losses2;
                }

                if (config.enableHuddle) {
                    team1.huddleScores.push(match.huddle2);
                    team2.huddleScores.push(match.huddle1);
                }

                if (config.enableBadges) {
                    if (getBadgeStatus(match, 1).validated) team1.badgesValidated++;
                    if (getBadgeStatus(match, 2).validated) team2.badgesValidated++;
                }
            });

            // Sort teams
            return [...teams].sort((a, b) => {
                if (b.wins !== a.wins) return b.wins - a.wins;
                const diffA = a.points - a.pointsAgainst;
                const diffB = b.points - b.pointsAgainst;
                return diffB - diffA;
            });
        }

        function generateRankingTable(ranking) {
            let html = '<table><thead><tr>';
            html += '<th>Position</th>';
            html += '<th>√âquipe</th>';
            html += '<th>Victoires</th>';
            html += '<th>Points marqu√©s</th>';
            html += '<th>Points encaiss√©s</th>';
            html += '<th>Diff√©rence</th>';

            if (config.enableLosses) {
                html += '<th>% Efficacit√©</th>';
            }

            if (config.enableBadges) {
                html += '<th>Badges valid√©s</th>';
            }

            if (config.enableHuddle) {
                html += '<th>Moy. Huddle</th>';
            }

            html += '</tr></thead><tbody>';

            ranking.forEach((team, i) => {
                html += '<tr>';
                html += `<td>${i + 1}</td>`;
                html += `<td><strong>${team.name}</strong></td>`;
                html += `<td>${team.wins}</td>`;
                html += `<td>${team.points}</td>`;
                html += `<td>${team.pointsAgainst}</td>`;
                html += `<td>${team.points - team.pointsAgainst}</td>`;

                if (config.enableLosses) {
                    const total = team.points + team.losses;
                    const efficiency = total > 0 ? (team.points / total * 100).toFixed(1) : 0;
                    html += `<td>${efficiency}%</td>`;
                }

                if (config.enableBadges) {
                    html += `<td>${team.badgesValidated}</td>`;
                }

                if (config.enableHuddle) {
                    const validScores = team.huddleScores.filter(score => score > 0);
                    const avg = validScores.length > 0 
                        ? (validScores.reduce((a, b) => a + b, 0) / validScores.length).toFixed(2)
                        : '0.00';
                    html += `<td>${avg}</td>`;
                }

                html += '</tr>';
            });

            html += '</tbody></table>';
            return html;
        }

        function exportRanking() {
            const ranking = calculateRanking();
            
            // Prepare data
            const headers = ['Position', '√âquipe', 'Victoires', 'Points marqu√©s', 'Points encaiss√©s', 'Diff√©rence'];
            
            if (config.enableLosses) headers.push('% Efficacit√©');
            if (config.enableBadges) headers.push('Badges valid√©s');
            if (config.enableHuddle) headers.push('Moy. Huddle');

            const data = [headers];

            ranking.forEach((team, i) => {
                const row = [
                    i + 1,
                    team.name,
                    team.wins,
                    team.points,
                    team.pointsAgainst,
                    team.points - team.pointsAgainst
                ];

                if (config.enableLosses) {
                    const total = team.points + team.losses;
                    const efficiency = total > 0 ? (team.points / total * 100).toFixed(1) : 0;
                    row.push(efficiency + '%');
                }

                if (config.enableBadges) {
                    row.push(team.badgesValidated);
                }

                if (config.enableHuddle) {
                    const avg = team.huddleScores.length > 0 
                        ? (team.huddleScores.reduce((a, b) => a + b, 0) / team.huddleScores.length).toFixed(2)
                        : '0.00';
                    row.push(avg);
                }

                data.push(row);
            });

            // Create workbook
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Classement");

            // Generate filename
            const now = new Date();
            const filename = `classement_ultimate_${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}h${String(now.getMinutes()).padStart(2,'0')}.xlsx`;

            // Download
            XLSX.writeFile(wb, filename);
        }

        function finishTournament() {
            pauseGlobalTimer();
            
            // Show final ranking
            const ranking = calculateRanking();
            const html = generateRankingTable(ranking);
            document.getElementById('finalRankingTable').innerHTML = html;
            
            document.getElementById('tournamentPage').classList.add('hidden');
            document.getElementById('finalPage').classList.remove('hidden');
        }

        function backToConfig() {
            if (confirm('Voulez-vous vraiment retourner √† la configuration ?\n\nToutes les donn√©es du tournoi seront r√©initialis√©es.')) {
                // Reset everything
                teams = [];
                matches = [];
                currentRotation = 0;
                globalTimer = {
                    timeRemaining: 0,
                    interval: null,
                    running: false
                };
                
                document.getElementById('finalPage').classList.add('hidden');
                document.getElementById('configPage').classList.remove('hidden');
                
                // Reset form
                document.getElementById('numTeams').value = 4;
                document.getElementById('matchDuration').value = 10;
                document.getElementById('enableLosses').checked = false;
                document.getElementById('enableBadges').checked = false;
                document.getElementById('enableHuddle').checked = false;
                document.getElementById('badgeOptions').classList.add('hidden');
                
                renderTeamList();
                updateFieldOptions();
            }
        }

        // Initialize
        updateFieldOptions();
    </script>
</body>
</html>